# MSPAD 实验运行指南

本文档包含三个实验（对比实验、参数敏感性分析、消融实验）在 **ALFA** 和 **FWUAV** 数据集上的常用运行命令。

## 目录

- [1. 对比实验](#1-对比实验)
- [2. 参数敏感性分析](#2-参数敏感性分析)
- [3. 消融实验](#3-消融实验)

---

## 1. 对比实验

对比实验用于比较 MSPAD、DACAD 和 CLUDA 三个算法在 ALFA 和 FWUAV 数据集上的性能。

### ALFA 数据集

#### 单个源-目标对实验
```bash
# 使用 flight 001 作为源域，flight 002 作为目标域
python experiments/comparison_experiments.py --dataset ALFA --src 001 --trg 002

# 使用 flight 001 作为源域，flight 003 作为目标域
python experiments/comparison_experiments.py --dataset ALFA --src 001 --trg 003
```

#### 指定源域，所有其他 flights 作为目标域（推荐）
```bash
# 使用 flight 001 作为源域，所有其他 flights 作为目标域
python experiments/comparison_experiments.py --dataset ALFA --src 001 --all-targets

# 使用 flight 002 作为源域，所有其他 flights 作为目标域
python experiments/comparison_experiments.py --dataset ALFA --src 002 --all-targets
```

#### 断点续传模式
```bash
# 跳过已完成的实验，继续运行未完成的实验
python experiments/comparison_experiments.py --dataset ALFA --src 001 --all-targets --skip-completed
```

#### 自定义训练参数
```bash
# 自定义训练轮数、学习率等参数
python experiments/comparison_experiments.py --dataset ALFA --src 001 --all-targets \
    --num_epochs 30 \
    --learning_rate 5e-5 \
    --seed 42
```

### FWUAV 数据集

#### 单个源-目标对实验
```bash
# 使用场景 1 作为源域，场景 2 作为目标域
python experiments/comparison_experiments.py --dataset FWUAV --src 1 --trg 2

# 使用场景 1 作为源域，场景 6 作为目标域
python experiments/comparison_experiments.py --dataset FWUAV --src 1 --trg 6
```

#### 指定源域，所有其他场景作为目标域（推荐）
```bash
# 使用场景 1 作为源域，所有其他场景作为目标域
python experiments/comparison_experiments.py --dataset FWUAV --src 1 --all-targets

# 使用场景 2 作为源域，所有其他场景作为目标域
python experiments/comparison_experiments.py --dataset FWUAV --src 2 --all-targets
```

#### 断点续传模式
```bash
# 跳过已完成的实验，继续运行未完成的实验
python experiments/comparison_experiments.py --dataset FWUAV --src 1 --all-targets --skip-completed
```

#### 自定义训练参数
```bash
# 自定义训练轮数、学习率等参数
python experiments/comparison_experiments.py --dataset FWUAV --src 1 --all-targets \
    --num_epochs 30 \
    --learning_rate 5e-5 \
    --seed 42
```

### 同时运行多个数据集
```bash
# 同时在 ALFA 和 FWUAV 数据集上运行，使用相同的源域ID
python experiments/comparison_experiments.py --datasets ALFA FWUAV --src 001 --all-targets

# 注意：ALFA 使用 flight ID（如 001），FWUAV 使用场景 ID（如 1）
# 如果源域ID不匹配，需要分别运行
```

### 结果保存位置

对比实验结果保存在：
- CSV文件：`experiment_results/comparison/Comparison_{dataset}_{src}.csv`
- 每个源-目标对作为一行，包含三个算法的性能指标（AUROC、AUPRC、Best_F1）

---

## 2. 参数敏感性分析

参数敏感性分析用于评估 MSPAD 各个超参数对性能的影响，找到最优参数配置。

### ALFA 数据集

#### 分析所有参数（默认）
```bash
# 使用 flight 001 作为源域，flight 002 作为目标域，分析所有参数
python experiments/sensitivity_analysis.py --dataset ALFA --src 001 --trg 002

# 使用 flight 001 作为源域，flight 002 作为目标域，分析所有参数（跳过已完成的实验）
python experiments/sensitivity_analysis.py --dataset ALFA --src 001 --trg 002 --skip-completed
```

#### 分析特定参数
```bash
# 分析多尺度域对抗损失权重
python experiments/sensitivity_analysis.py --dataset ALFA --src 001 --trg 002 --param weight_loss_ms_disc

# 分析原型网络间隔参数
python experiments/sensitivity_analysis.py --dataset ALFA --src 001 --trg 002 --param prototypical_margin

# 分析源域监督对比损失权重
python experiments/sensitivity_analysis.py --dataset ALFA --src 001 --trg 002 --param weight_loss_src_sup

# 分析目标域注入对比损失权重
python experiments/sensitivity_analysis.py --dataset ALFA --src 001 --trg 002 --param weight_loss_trg_inj

# 分析多尺度层权重
python experiments/sensitivity_analysis.py --dataset ALFA --src 001 --trg 002 --param scale_weights
```

#### 自定义训练参数
```bash
# 自定义训练轮数、批次大小等参数（适用于GPU显存不足的情况）
python experiments/sensitivity_analysis.py --dataset ALFA --src 001 --trg 002 \
    --num_epochs 20 \
    --batch-size 64 \
    --queue-size 24576 \
    --seed 2021
```

### FWUAV 数据集

#### 分析所有参数（默认）
```bash
# 使用场景 1 作为源域，场景 2 作为目标域，分析所有参数
python experiments/sensitivity_analysis.py --dataset FWUAV --src 1 --trg 2

# 使用场景 1 作为源域，场景 2 作为目标域，分析所有参数（跳过已完成的实验）
python experiments/sensitivity_analysis.py --dataset FWUAV --src 1 --trg 2 --skip-completed
```

#### 分析特定参数
```bash
# 分析多尺度域对抗损失权重
python experiments/sensitivity_analysis.py --dataset FWUAV --src 1 --trg 2 --param weight_loss_ms_disc

# 分析原型网络间隔参数
python experiments/sensitivity_analysis.py --dataset FWUAV --src 1 --trg 2 --param prototypical_margin

# 分析源域监督对比损失权重
python experiments/sensitivity_analysis.py --dataset FWUAV --src 1 --trg 2 --param weight_loss_src_sup

# 分析目标域注入对比损失权重
python experiments/sensitivity_analysis.py --dataset FWUAV --src 1 --trg 2 --param weight_loss_trg_inj

# 分析多尺度层权重
python experiments/sensitivity_analysis.py --dataset FWUAV --src 1 --trg 2 --param scale_weights
```

#### 自定义训练参数
```bash
# 自定义训练轮数、批次大小等参数（适用于GPU显存不足的情况）
python experiments/sensitivity_analysis.py --dataset FWUAV --src 1 --trg 2 \
    --num_epochs 20 \
    --batch-size 64 \
    --queue-size 24576 \
    --seed 2021
```

### 可分析的参数列表

1. **weight_loss_ms_disc**: 多尺度域对抗损失权重（默认值：0.3）
2. **prototypical_margin**: 原型网络间隔参数（默认值：1.0）
3. **weight_loss_src_sup**: 源域监督对比损失权重（默认值：0.1）
4. **weight_loss_trg_inj**: 目标域注入对比损失权重（默认值：0.1）
5. **scale_weights**: 多尺度层权重（默认值：[0.1, 0.3, 0.6]）

### 结果保存位置

参数敏感性分析结果保存在：
- CSV文件：`experiment_results/sensitivity/Sensitivity_{param_name}_{dataset}_{src}.csv`
- JSON摘要：`experiment_results/sensitivity/sensitivity_analysis_{dataset}_{src}_{trg}.json`
- 每个参数值作为一行，包含性能指标（AUROC、AUPRC、Best_F1）

---

## 3. 消融实验

消融实验用于验证 MSPAD 各个核心组件的贡献。实验设计为：完整模型 + 消去各个组件后的模型。

### ALFA 数据集

#### 运行核心组件消融实验（默认）
```bash
# 使用 flight 001 作为源域，flight 002 作为目标域，运行核心组件消融实验（默认）
python experiments/ablation_experiments.py --dataset ALFA --src 001 --trg 002

# 使用 flight 001 作为源域，所有其他 flights 作为目标域，运行核心组件消融实验（推荐）
python experiments/ablation_experiments.py --dataset ALFA --src 001 --all-targets
```

#### 自定义训练参数
```bash
# 自定义训练轮数、随机种子等参数
python experiments/ablation_experiments.py --dataset ALFA --src 001 --all-targets \
    --num_epochs 30 \
    --seed 2021
```

### FWUAV 数据集

#### 运行核心组件消融实验（默认）
```bash
# 使用场景 1 作为源域，场景 2 作为目标域，运行核心组件消融实验（默认）
python experiments/ablation_experiments.py --dataset FWUAV --src 1 --trg 2

# 使用场景 1 作为源域，所有其他场景作为目标域，运行核心组件消融实验（推荐）
python experiments/ablation_experiments.py --dataset FWUAV --src 1 --all-targets
```

#### 自定义训练参数
```bash
# 自定义训练轮数、随机种子等参数
python experiments/ablation_experiments.py --dataset FWUAV --src 1 --all-targets \
    --num_epochs 30 \
    --seed 2021
```

### 消融实验组说明

#### 核心组件消融（core）- 默认组
实验设计：完整模型 + 消去各个组件后的模型

1. **Abl-Full**: MSPAD Full（完整模型，所有组件）
   - 多尺度域对抗 + 原型网络 + 所有损失函数

2. **Abl-w/o-MS-DA**: 移除多尺度域对抗损失
   - 移除多尺度域对抗损失，保留其他组件

3. **Abl-w/o-Prototypical**: 移除原型网络分类损失
   - 将原型网络分类损失权重设为0，保留其他组件

4. **Abl-w/o-SrcSupCL**: 移除源域监督对比损失
   - 移除源域监督对比损失，保留其他组件

5. **Abl-w/o-TrgInjCL**: 移除目标域注入对比损失
   - 移除目标域注入对比损失，保留其他组件

**注意**：multi_scale 和 loss 组已移除，如需运行请从历史版本恢复代码

### 结果保存位置

消融实验结果保存在：
- CSV文件：`experiment_results/ablation/Ablation_{group}_{dataset}_{src}.csv`
- JSON摘要：`experiment_results/ablation/ablation_results_{dataset}_{src}_{trg}.json` 或 `ablation_results_{dataset}_{src}_all_targets.json`
- 每个实验ID作为一行，包含性能指标（AUROC、AUPRC、Best_F1）

---

## 通用参数说明

### 数据集ID格式

- **ALFA**: 使用 flight ID，格式为三位数字（如 `001`, `002`, `003`）
- **FWUAV**: 使用场景 ID，格式为单个数字（如 `1`, `2`, `6`）

### 常用参数

- `--num_epochs`: 训练轮数（默认：20）
- `--seed`: 随机种子（对比实验默认：42，其他实验默认：2021）
- `--skip-completed`: 跳过已完成的实验（断点续传）
- `--learning_rate`: 学习率（默认：1e-4）
- `--batch-size`: 批次大小（默认：数据集特定值）
- `--queue-size`: MoCo队列大小（默认：98304）

### GPU显存优化

如果遇到GPU显存不足的问题，可以减小批次大小和队列大小：

```bash
# 减小批次大小和队列大小
python experiments/sensitivity_analysis.py --dataset ALFA --src 001 --trg 002 \
    --batch-size 64 \
    --queue-size 24576
```

---

## 结果文件结构

所有实验结果统一保存在 `experiment_results/` 目录下：

```
experiment_results/
├── comparison/              # 对比实验结果
│   └── Comparison_{dataset}_{src}.csv
├── sensitivity/             # 参数敏感性分析结果
│   ├── Sensitivity_{param_name}_{dataset}_{src}.csv
│   └── sensitivity_analysis_{dataset}_{src}_{trg}.json
└── ablation/                # 消融实验结果
    ├── Ablation_{group}_{dataset}_{src}.csv
    └── ablation_results_{dataset}_{src}_{trg}.json
```

---

## 注意事项

1. **数据集路径**: 确保数据集文件位于正确的路径：
   - ALFA: `datasets/ALFA/`
   - FWUAV: `datasets/FWUAV/`

2. **源域ID格式**: 
   - ALFA 使用三位数字格式（如 `001`），不是 `1`
   - FWUAV 使用单个数字格式（如 `1`），不是 `001`

3. **断点续传**: 使用 `--skip-completed` 参数可以跳过已完成的实验，节省时间

4. **GPU显存**: 如果显存不足，可以减小 `--batch-size` 和 `--queue-size` 参数

5. **实验顺序**: 建议先运行对比实验，再运行参数敏感性分析，最后运行消融实验

---

## 快速开始示例

### ALFA 数据集完整实验流程

```bash
# 1. 对比实验
python experiments/comparison_experiments.py --dataset ALFA --src 001 --all-targets

# 2. 参数敏感性分析（分析关键参数）
python experiments/sensitivity_analysis.py --dataset ALFA --src 001 --trg 002 --param weight_loss_ms_disc
python experiments/sensitivity_analysis.py --dataset ALFA --src 001 --trg 002 --param prototypical_margin

# 3. 消融实验（核心组件）
python experiments/ablation_experiments.py --dataset ALFA --src 001 --all-targets --group core
```

### FWUAV 数据集完整实验流程

```bash
# 1. 对比实验
python experiments/comparison_experiments.py --dataset FWUAV --src 1 --all-targets

# 2. 参数敏感性分析（分析关键参数）
python experiments/sensitivity_analysis.py --dataset FWUAV --src 1 --trg 2 --param weight_loss_ms_disc
python experiments/sensitivity_analysis.py --dataset FWUAV --src 1 --trg 2 --param prototypical_margin

# 3. 消融实验（核心组件）
python experiments/ablation_experiments.py --dataset FWUAV --src 1 --all-targets --group core
```

---

*最后更新：2024年*

