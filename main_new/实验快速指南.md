# 消融实验与参数敏感性分析 - 快速指南

## 🚀 快速开始

### 1. 运行消融实验

```bash
# 运行所有消融实验（需要较长时间，建议后台运行）
python main_new/run_ablation_experiments.py

# 或者使用nohup在后台运行
nohup python main_new/run_ablation_experiments.py > ablation.log 2>&1 &
```

### 2. 运行参数敏感性分析

```bash
# 分析多尺度损失权重的敏感性
python main_new/run_sensitivity_analysis.py

# 后台运行
nohup python main_new/run_sensitivity_analysis.py > sensitivity.log 2>&1 &
```

### 3. 分析实验结果

```bash
# 生成结果报告和可视化图表
python main_new/analyze_results.py
```

## 📊 实验内容

### 消融实验

| 实验 | 说明 | 预期时间 |
|------|------|---------|
| Baseline | 原始DACAD | ~2小时 |
| Exp-1.1 | 完整多尺度DACAD | ~2小时 |
| Exp-1.2 | 仅多尺度（无单尺度） | ~2小时 |
| Exp-2.1-2.3 | 单层分析 | ~6小时 |
| Exp-2.7 | 所有层 | ~2小时 |
| Exp-3.1-3.3 | 权重配置分析 | ~6小时 |

**总时间**：约20小时（单GPU）

### 参数敏感性分析

| 分析 | 参数范围 | 实验数 | 预期时间 |
|------|---------|--------|---------|
| weight_loss_ms_disc | 0.0 - 0.7 | 8 | ~16小时 |

## 📁 结果文件

### 消融实验

- **结果目录**: `results/MSL_Baseline/`, `results/MSL_MSDA_Full/`, etc.
- **摘要文件**: `ablation_results_summary.json`
- **分析报告**: `ablation_results_analysis.csv`

### 敏感性分析

- **结果目录**: `results/MSL_Sensitivity_weight_loss_ms_disc_*/`
- **摘要文件**: `sensitivity_analysis_results.json`
- **分析报告**: `sensitivity_analysis_weight_loss_ms_disc.csv`
- **可视化图表**: `sensitivity_analysis_weight_loss_ms_disc.png`

## 🔍 结果解读

### 消融实验结果

查看 `ablation_results_analysis.csv`：

```python
import pandas as pd
df = pd.read_csv('ablation_results_analysis.csv')
print(df.sort_values('AUPRC', ascending=False))
```

**关键指标**：
- **AUPRC**: 主要评估指标，越高越好
- **F1 Score**: 精确率和召回率的调和平均
- **Improvement**: 相比Baseline的改进幅度

### 敏感性分析结果

查看 `sensitivity_analysis_weight_loss_ms_disc.csv`：

```python
import pandas as pd
import matplotlib.pyplot as plt

df = pd.read_csv('sensitivity_analysis_weight_loss_ms_disc.csv')
plt.plot(df['weight_loss_ms_disc'], df['AUPRC'], marker='o')
plt.xlabel('weight_loss_ms_disc')
plt.ylabel('AUPRC')
plt.title('Sensitivity Analysis')
plt.show()
```

**关键发现**：
- **最优值**: AUPRC最高的参数值
- **敏感性**: 参数变化对性能的影响程度
- **稳定区间**: 性能稳定的参数范围

## ⚙️ 自定义实验

### 修改实验配置

编辑 `run_ablation_experiments.py` 中的 `EXPERIMENTS` 字典：

```python
EXPERIMENTS = {
    'MyExperiment': {
        'algo_name': 'MSPAD',
        'weight_loss_disc': 0.5,
        'weight_loss_ms_disc': 0.4,  # 自定义值
        'experiment_folder': 'MSL_MyExp',
        'description': '我的实验'
    },
}
```

### 添加新的敏感性分析

编辑 `run_sensitivity_analysis.py`，添加新函数：

```python
def analyze_sensitivity_3_my_parameter():
    base_config = {...}
    param_values = [0.1, 0.2, 0.3]
    # ... 运行实验
```

## 📈 实验监控

### 查看训练进度

```bash
# 查看最新实验的日志
tail -f results/MSL_MSDA_Full/F-5-C-1/train.log

# 查看所有实验状态
python main_new/analyze_results.py
```

### 检查实验是否完成

```bash
# 检查结果文件是否存在
ls results/MSL_MSDA_Full/F-5-C-1/eval_*.log

# 查看实验摘要
cat ablation_results_summary.json | python -m json.tool
```

## 🐛 故障排除

### 实验失败

1. **检查GPU内存**：
   ```bash
   nvidia-smi
   ```
   如果内存不足，减小 `batch_size`

2. **检查数据路径**：
   确保 `datasets/MSL_SMAP/` 存在

3. **查看错误日志**：
   ```bash
   tail -100 results/MSL_MSDA_Full/F-5-C-1/train.log
   ```

### 结果文件缺失

1. **检查实验是否完成**：
   ```bash
   ls -lh results/MSL_MSDA_Full/F-5-C-1/
   ```

2. **重新运行评估**：
   ```bash
   python main_new/eval.py \
       --experiment_folder MSL_MSDA_Full \
       --id_src F-5 \
       --id_trg C-1
   ```

## 💡 最佳实践

1. **分批运行**：不要同时运行所有实验，分批进行
2. **定期备份**：定期备份 `results/` 目录
3. **记录配置**：每次实验前记录配置参数
4. **及时分析**：实验完成后及时分析结果

## 📚 相关文档

- `实验方案_消融与敏感性分析.md`: 详细实验方案
- `README.md`: 模型使用说明
- `改进方案.md`: 改进方案说明

## 🎯 预期结果

### 消融实验预期

- **Exp-1.1 > Baseline**: 多尺度域对抗有效（+2-5% AUPRC）
- **Exp-2.3 > Exp-2.1**: 高层特征更重要
- **Exp-3.1最优**: 默认权重配置最佳

### 敏感性分析预期

- **最优权重**: `weight_loss_ms_disc ≈ 0.3`
- **稳定区间**: 0.2 - 0.4
- **性能曲线**: 先增后减的倒U型曲线

## 📞 问题反馈

如遇到问题，请检查：
1. Python版本（需要3.8+）
2. PyTorch版本（需要1.8+）
3. CUDA版本（需要10.2+）
4. 依赖包是否完整安装

