# 多尺度域自适应DACAD - 消融实验与参数敏感性分析方案

## 📋 目录

1. [实验目标](#实验目标)
2. [消融实验设计](#消融实验设计)
3. [参数敏感性分析](#参数敏感性分析)
4. [实验配置](#实验配置)
5. [运行脚本](#运行脚本)
6. [结果分析](#结果分析)

---

## 实验目标

### 主要目标

1. **验证多尺度域对抗的有效性**：证明多尺度域对抗比单尺度域对抗更有效
2. **分析不同层的贡献**：了解低层、中层、高层域对齐的相对重要性
3. **确定最优参数配置**：找到最佳的多尺度损失权重和层权重组合
4. **评估参数敏感性**：分析关键参数对性能的影响

### 评估指标

- **AUPRC** (Area Under Precision-Recall Curve)：主要指标
- **Best F1 Score**：最佳F1分数
- **Precision & Recall**：精确率和召回率

---

## 消融实验设计

### 实验1：多尺度域对抗 vs 单尺度域对抗

**目的**：验证多尺度域对抗的有效性

| 实验编号 | 模型配置 | 说明 |
|---------|---------|------|
| Baseline | 原始DACAD | 只有单尺度域对抗（最终层） |
| Exp-1.1 | 多尺度DACAD（完整版） | 3层多尺度 + 单尺度 |
| Exp-1.2 | 多尺度DACAD（仅多尺度） | 只有3层多尺度，无单尺度 |

**假设**：
- Exp-1.1 > Baseline：多尺度域对抗有效
- Exp-1.1 > Exp-1.2：单尺度域对抗仍有作用

### 实验2：不同层的贡献分析

**目的**：分析低层、中层、高层的相对重要性

| 实验编号 | 配置 | 说明 |
|---------|------|------|
| Exp-2.1 | 仅低层（Layer 1） | 只在第1层进行域对抗 |
| Exp-2.2 | 仅中层（Layer 2） | 只在第2层进行域对抗 |
| Exp-2.3 | 仅高层（Layer 3） | 只在第3层进行域对抗 |
| Exp-2.4 | 低层+中层 | Layer 1 + Layer 2 |
| Exp-2.5 | 中层+高层 | Layer 2 + Layer 3 |
| Exp-2.6 | 低层+高层 | Layer 1 + Layer 3 |
| Exp-2.7 | 完整（所有层） | Layer 1 + Layer 2 + Layer 3 |

**假设**：
- 高层 > 中层 > 低层：高层特征更重要
- 完整配置 > 任何子集：所有层都有贡献

### 实验3：层权重配置分析

**目的**：分析不同层权重分配的影响

| 实验编号 | 权重配置 | 说明 |
|---------|---------|------|
| Exp-3.1 | [0.1, 0.3, 0.6] | 默认配置（低→高递增） |
| Exp-3.2 | [0.33, 0.33, 0.34] | 均匀权重 |
| Exp-3.3 | [0.6, 0.3, 0.1] | 低层权重高（反向） |
| Exp-3.4 | [0.0, 0.0, 1.0] | 仅高层 |
| Exp-3.5 | [0.2, 0.4, 0.4] | 中高层权重高 |

**假设**：
- Exp-3.1最优：高层权重应该更大
- 均匀权重次优：不同层的重要性不同

### 实验4：多尺度损失权重敏感性

**目的**：分析多尺度域对抗损失权重的影响

| 实验编号 | weight_loss_ms_disc | 说明 |
|---------|---------------------|------|
| Exp-4.1 | 0.0 | 无多尺度损失（等价于Baseline） |
| Exp-4.2 | 0.1 | 较小权重 |
| Exp-4.3 | 0.2 | 中等权重 |
| Exp-4.4 | 0.3 | 默认权重 |
| Exp-4.5 | 0.4 | 较大权重 |
| Exp-4.6 | 0.5 | 大权重 |
| Exp-4.7 | 0.7 | 很大权重 |

**假设**：
- 存在最优权重（可能在0.2-0.4之间）
- 权重过大或过小都会降低性能

---

## 参数敏感性分析

### 分析1：多尺度损失权重 (weight_loss_ms_disc)

**参数范围**：0.0 - 1.0，步长0.1

**分析维度**：
- 对AUPRC的影响
- 对F1 Score的影响
- 对训练稳定性的影响（损失曲线）

**预期结果**：
- 最优值可能在0.2-0.4之间
- 权重过大会导致域对抗过强，影响分类性能
- 权重过小会导致域对齐不充分

### 分析2：TCN层数配置

**配置选项**：
- `128-256-512`（3层，默认）
- `128-256`（2层）
- `256-512`（2层，跳过低层）
- `128-256-512-1024`（4层）

**分析维度**：
- 不同层数对性能的影响
- 计算成本 vs 性能提升
- 不同数据集的最优层数

### 分析3：单尺度 vs 多尺度损失权重比例

**分析配置**：
- 固定 `weight_loss_disc = 0.5`
- 变化 `weight_loss_ms_disc`：0.0 - 0.8
- 分析两者比例对性能的影响

**预期结果**：
- 存在最优比例（如 0.5:0.3）
- 两者需要平衡

### 分析4：不同数据集上的表现

**数据集**：
- MSL（Mars Science Laboratory）
- SMD（Server Machine Dataset）
- Boiler（Boiler Fault Detection）

**分析维度**：
- 不同数据集的最优参数是否相同
- 多尺度域对抗在不同数据集上的有效性
- 域差异大小对多尺度效果的影响

---

## 实验配置

### 基础配置（所有实验共享）

```python
基础超参数 = {
    'num_epochs': 20,
    'batch_size': 256,
    'eval_batch_size': 256,
    'learning_rate': 1e-4,
    'dropout': 0.1,
    'weight_decay': 1e-4,
    'num_channels_TCN': '128-256-512',
    'dilation_factor_TCN': 3,
    'kernel_size_TCN': 7,
    'hidden_dim_MLP': 1024,
    'queue_size': 98304,
    'momentum': 0.99,
    'weight_loss_pred': 1.0,
    'weight_loss_src_sup': 0.1,
    'weight_loss_trg_inj': 0.1,
}
```

### 实验特定配置

#### 消融实验配置

```python
消融实验配置 = {
    'Baseline': {
        'algo_name': 'dacad',  # 使用原始DACAD
        'weight_loss_disc': 0.5,
        'weight_loss_ms_disc': 0.0,  # 无多尺度
    },
    'Exp-1.1': {
        'algo_name': 'MSPAD',
        'weight_loss_disc': 0.5,
        'weight_loss_ms_disc': 0.3,
        'scale_weights': [0.1, 0.3, 0.6],  # 完整配置
    },
    'Exp-1.2': {
        'algo_name': 'MSPAD',
        'weight_loss_disc': 0.0,  # 无单尺度
        'weight_loss_ms_disc': 0.3,
        'scale_weights': [0.1, 0.3, 0.6],
    },
    # ... 其他实验配置
}
```

---

## 运行脚本

### 脚本1：消融实验自动化脚本

创建 `run_ablation_experiments.py`：

```python
"""
消融实验自动化运行脚本
"""
import os
import subprocess
import json
from datetime import datetime

# 实验配置
EXPERIMENTS = {
    'Baseline': {
        'algo_name': 'dacad',
        'weight_loss_disc': 0.5,
        'weight_loss_ms_disc': 0.0,
        'experiment_folder': 'MSL_Baseline',
    },
    'Exp-1.1': {
        'algo_name': 'MSPAD',
        'weight_loss_disc': 0.5,
        'weight_loss_ms_disc': 0.3,
        'experiment_folder': 'MSL_MSDA_Full',
    },
    'Exp-1.2': {
        'algo_name': 'MSPAD',
        'weight_loss_disc': 0.0,
        'weight_loss_ms_disc': 0.3,
        'experiment_folder': 'MSL_MSDA_MSOnly',
    },
    # ... 添加更多实验配置
}

def run_experiment(exp_name, config, src='F-5', trg='C-1'):
    """运行单个实验"""
    print(f"\n{'='*60}")
    print(f"Running Experiment: {exp_name}")
    print(f"Configuration: {config}")
    print(f"{'='*60}\n")
    
    train_cmd = [
        'python', 'main_new/train.py',
        '--algo_name', config['algo_name'],
        '--num_epochs', '20',
        '--batch_size', '256',
        '--learning_rate', '1e-4',
        '--num_channels_TCN', '128-256-512',
        '--weight_loss_disc', str(config['weight_loss_disc']),
        '--weight_loss_ms_disc', str(config['weight_loss_ms_disc']),
        '--id_src', src,
        '--id_trg', trg,
        '--experiment_folder', config['experiment_folder'],
    ]
    
    # 运行训练
    result = subprocess.run(train_cmd, capture_output=True, text=True)
    
    if result.returncode != 0:
        print(f"Training failed for {exp_name}")
        print(result.stderr)
        return False
    
    # 运行评估
    eval_cmd = [
        'python', 'main_new/eval.py',
        '--experiments_main_folder', 'results',
        '--experiment_folder', config['experiment_folder'],
        '--id_src', src,
        '--id_trg', trg,
    ]
    
    result = subprocess.run(eval_cmd, capture_output=True, text=True)
    
    if result.returncode != 0:
        print(f"Evaluation failed for {exp_name}")
        print(result.stderr)
        return False
    
    print(f"✓ Experiment {exp_name} completed successfully")
    return True

if __name__ == '__main__':
    # 运行所有实验
    results = {}
    for exp_name, config in EXPERIMENTS.items():
        success = run_experiment(exp_name, config)
        results[exp_name] = 'Success' if success else 'Failed'
    
    # 保存结果摘要
    summary = {
        'timestamp': datetime.now().isoformat(),
        'results': results
    }
    
    with open('ablation_results_summary.json', 'w') as f:
        json.dump(summary, f, indent=2)
    
    print("\n" + "="*60)
    print("All experiments completed!")
    print("="*60)
    for exp_name, status in results.items():
        print(f"{exp_name}: {status}")
```

### 脚本2：参数敏感性分析脚本

创建 `run_sensitivity_analysis.py`：

```python
"""
参数敏感性分析自动化脚本
"""
import os
import subprocess
import json
import numpy as np
from datetime import datetime

def run_sensitivity_analysis(param_name, param_values, base_config, src='F-5', trg='C-1'):
    """
    运行参数敏感性分析
    
    参数:
        param_name: 参数名称（如 'weight_loss_ms_disc'）
        param_values: 参数值列表
        base_config: 基础配置字典
    """
    results = {}
    
    for value in param_values:
        config = base_config.copy()
        config[param_name] = value
        
        exp_name = f"{param_name}_{value}"
        config['experiment_folder'] = f"MSL_Sensitivity_{param_name}_{value}"
        
        print(f"\nRunning: {exp_name} = {value}")
        
        # 构建训练命令
        train_cmd = [
            'python', 'main_new/train.py',
            '--algo_name', 'MSPAD',
            '--num_epochs', '20',
            '--batch_size', '256',
            '--learning_rate', '1e-4',
            '--num_channels_TCN', '128-256-512',
            '--id_src', src,
            '--id_trg', trg,
            '--experiment_folder', config['experiment_folder'],
        ]
        
        # 添加所有配置参数
        for key, val in config.items():
            if key != 'experiment_folder':
                train_cmd.extend([f'--{key}', str(val)])
        
        # 运行训练
        result = subprocess.run(train_cmd, capture_output=True, text=True)
        
        if result.returncode == 0:
            # 运行评估
            eval_cmd = [
                'python', 'main_new/eval.py',
                '--experiments_main_folder', 'results',
                '--experiment_folder', config['experiment_folder'],
                '--id_src', src,
                '--id_trg', trg,
            ]
            
            subprocess.run(eval_cmd)
            results[value] = 'Success'
        else:
            results[value] = 'Failed'
            print(f"Failed: {result.stderr}")
    
    return results

if __name__ == '__main__':
    # 基础配置
    base_config = {
        'weight_loss_disc': 0.5,
        'weight_loss_pred': 1.0,
        'weight_loss_src_sup': 0.1,
        'weight_loss_trg_inj': 0.1,
    }
    
    # 分析1：多尺度损失权重敏感性
    print("="*60)
    print("Sensitivity Analysis 1: weight_loss_ms_disc")
    print("="*60)
    
    ms_disc_values = [0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7]
    results_ms = run_sensitivity_analysis(
        'weight_loss_ms_disc',
        ms_disc_values,
        base_config
    )
    
    # 保存结果
    summary = {
        'timestamp': datetime.now().isoformat(),
        'weight_loss_ms_disc': results_ms,
    }
    
    with open('sensitivity_analysis_results.json', 'w') as f:
        json.dump(summary, f, indent=2)
    
    print("\nSensitivity analysis completed!")
    print(json.dumps(summary, indent=2))
```

---

## 结果分析

### 分析脚本：结果汇总

创建 `analyze_results.py`：

```python
"""
实验结果分析和可视化脚本
"""
import os
import json
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from glob import glob

def extract_metrics_from_log(log_file):
    """从日志文件中提取评估指标"""
    metrics = {}
    try:
        with open(log_file, 'r') as f:
            lines = f.readlines()
            for line in lines:
                if 'AUPRC score is' in line:
                    metrics['AUPRC'] = float(line.split(':')[1].strip())
                elif 'Best F1 score is' in line:
                    metrics['F1'] = float(line.split(':')[1].strip())
                elif 'Best Prec score is' in line:
                    metrics['Precision'] = float(line.split(':')[1].strip())
                elif 'Best Rec score is' in line:
                    metrics['Recall'] = float(line.split(':')[1].strip())
    except:
        pass
    return metrics

def collect_ablation_results():
    """收集消融实验结果"""
    results = []
    
    experiment_folders = [
        'MSL_Baseline',
        'MSL_MSDA_Full',
        'MSL_MSDA_MSOnly',
        # ... 添加更多实验文件夹
    ]
    
    for folder in experiment_folders:
        log_files = glob(f'results/{folder}/F-5-C-1/eval_*.log')
        if log_files:
            metrics = extract_metrics_from_log(log_files[0])
            metrics['Experiment'] = folder
            results.append(metrics)
    
    return pd.DataFrame(results)

def plot_sensitivity_analysis(param_values, metrics_dict, param_name):
    """绘制参数敏感性分析图"""
    fig, axes = plt.subplots(2, 2, figsize=(12, 10))
    
    # AUPRC
    axes[0, 0].plot(param_values, [metrics_dict.get(v, {}).get('AUPRC', 0) for v in param_values], 
                    marker='o', linewidth=2, markersize=8)
    axes[0, 0].set_xlabel(param_name)
    axes[0, 0].set_ylabel('AUPRC')
    axes[0, 0].set_title(f'AUPRC vs {param_name}')
    axes[0, 0].grid(True, alpha=0.3)
    
    # F1 Score
    axes[0, 1].plot(param_values, [metrics_dict.get(v, {}).get('F1', 0) for v in param_values],
                    marker='s', linewidth=2, markersize=8, color='orange')
    axes[0, 1].set_xlabel(param_name)
    axes[0, 1].set_ylabel('F1 Score')
    axes[0, 1].set_title(f'F1 Score vs {param_name}')
    axes[0, 1].grid(True, alpha=0.3)
    
    # Precision
    axes[1, 0].plot(param_values, [metrics_dict.get(v, {}).get('Precision', 0) for v in param_values],
                     marker='^', linewidth=2, markersize=8, color='green')
    axes[1, 0].set_xlabel(param_name)
    axes[1, 0].set_ylabel('Precision')
    axes[1, 0].set_title(f'Precision vs {param_name}')
    axes[1, 0].grid(True, alpha=0.3)
    
    # Recall
    axes[1, 1].plot(param_values, [metrics_dict.get(v, {}).get('Recall', 0) for v in param_values],
                     marker='d', linewidth=2, markersize=8, color='red')
    axes[1, 1].set_xlabel(param_name)
    axes[1, 1].set_ylabel('Recall')
    axes[1, 1].set_title(f'Recall vs {param_name}')
    axes[1, 1].grid(True, alpha=0.3)
    
    plt.tight_layout()
    plt.savefig(f'sensitivity_analysis_{param_name}.png', dpi=300, bbox_inches='tight')
    print(f"Saved: sensitivity_analysis_{param_name}.png")

if __name__ == '__main__':
    # 收集消融实验结果
    ablation_df = collect_ablation_results()
    ablation_df.to_csv('ablation_results.csv', index=False)
    print("\nAblation Results:")
    print(ablation_df.to_string())
    
    # 绘制敏感性分析图
    # ... 添加绘图代码
```

---

## 实验执行计划

### 阶段1：消融实验（优先级：高）

1. **Week 1**: 实验1（多尺度 vs 单尺度）
2. **Week 2**: 实验2（不同层的贡献）
3. **Week 3**: 实验3（层权重配置）

### 阶段2：参数敏感性分析（优先级：中）

4. **Week 4**: 多尺度损失权重敏感性
5. **Week 5**: TCN层数配置分析
6. **Week 6**: 不同数据集上的表现

### 阶段3：结果分析与报告（优先级：高）

7. **Week 7**: 结果汇总和分析
8. **Week 8**: 撰写实验报告

---

## 预期发现

1. **多尺度域对抗有效**：预期提升2-5% AUPRC
2. **高层特征更重要**：高层域对齐的贡献 > 低层
3. **最优权重配置**：`weight_loss_ms_disc ≈ 0.3`，层权重 `[0.1, 0.3, 0.6]`
4. **参数敏感性**：多尺度损失权重在0.2-0.4之间效果最好

---

## 注意事项

1. **实验可复现性**：固定随机种子（seed=1234）
2. **资源管理**：合理安排GPU资源，避免同时运行过多实验
3. **结果备份**：定期备份实验结果和日志文件
4. **错误处理**：实验失败时记录错误信息，便于调试

---

## 参考

- 原始DACAD论文
- 多尺度域自适应相关文献
- 消融实验最佳实践

