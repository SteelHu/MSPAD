# MSPAD消融实验与参数敏感性分析方案

## 📋 目录

1. [MSPAD核心改进回顾](#mspad核心改进回顾)
2. [实验设计原则](#实验设计原则)
3. [消融实验设计](#消融实验设计)
4. [参数敏感性分析](#参数敏感性分析)
5. [实验优先级与执行顺序](#实验优先级与执行顺序)
6. [实验配置](#实验配置)
7. [运行脚本](#运行脚本)

---

## MSPAD核心改进回顾

MSPAD相比原始DACAD有三个核心改进：

### 改进1：多尺度域对抗训练（Multi-Scale Domain Adversarial Training）
- **机制**：在TCN的每个block后添加域判别器，实现层次化域对齐
- **创新点**：从单尺度（仅最终层）扩展到多尺度（所有中间层）
- **预期效果**：提升域对齐能力，减少不同层次的域差异

### 改进2：原型网络分类器（Prototypical Network Classifier）
- **机制**：使用原型网络替代Deep SVDD，学习正常样本的原型表示
- **创新点**：可学习的原型中心，更灵活地适应数据分布
- **预期效果**：提升分类性能，更稳定的异常检测

### 改进3：加权多尺度损失（Weighted Multi-Scale Loss）
- **机制**：不同层使用不同权重，低层权重小，高层权重大
- **创新点**：强调高层语义特征的重要性
- **预期效果**：平衡不同层次的特征对齐

---

## 实验设计原则

### 1. 渐进式验证
- **先验证单个改进的有效性**：逐个验证每个核心改进的贡献
- **再验证改进的组合效果**：验证多个改进组合的协同作用
- **最后优化参数配置**：在确认改进有效后，优化参数设置

### 2. 对比基准明确
- **Baseline 1**：原始DACAD（单尺度域对抗 + Deep SVDD）
- **Baseline 2**：仅添加改进1（多尺度域对抗 + Deep SVDD）
- **Baseline 3**：仅添加改进2（单尺度域对抗 + 原型网络）
- **Full MSPAD**：三个改进全部使用

### 3. 实验优先级
- **高优先级**：验证核心改进的有效性（消融实验）
- **中优先级**：优化关键参数（参数敏感性分析）
- **低优先级**：探索性实验（不同数据集、不同配置）

---

## 消融实验设计

### 第一部分：核心改进有效性验证（优先级：⭐⭐⭐⭐⭐）

**目的**：验证每个核心改进的独立贡献和组合效果

#### 实验1：Baseline对比（建立对比基准）

| 实验编号 | 配置 | 说明 | 预期结果 |
|---------|------|------|---------|
| **Baseline** | 原始DACAD | 单尺度域对抗 + Deep SVDD | 基准性能 |
| **Exp-1.1** | MSPAD完整版 | 多尺度域对抗 + 原型网络 + 加权损失 | 最优性能 |

**假设**：
- Exp-1.1 > Baseline：MSPAD优于原始DACAD
- 预期AUPRC提升：2-5%

#### 实验2：改进1的贡献（多尺度域对抗）

| 实验编号 | 配置 | 说明 | 预期结果 |
|---------|------|------|---------|
| **Exp-2.1** | 单尺度域对抗 + Deep SVDD | Baseline（原始DACAD） | 基准 |
| **Exp-2.2** | 多尺度域对抗 + Deep SVDD | 仅添加改进1 | 性能提升 |
| **Exp-2.3** | 单尺度域对抗 + 原型网络 | 仅添加改进2 | 性能提升 |
| **Exp-2.4** | 多尺度域对抗 + 原型网络 | 改进1 + 改进2 | 性能进一步提升 |

**假设**：
- Exp-2.2 > Exp-2.1：多尺度域对抗有效
- Exp-2.3 > Exp-2.1：原型网络有效
- Exp-2.4 > Exp-2.2 且 Exp-2.4 > Exp-2.3：两个改进有协同作用

#### 实验3：改进2的贡献（原型网络分类器）

| 实验编号 | 配置 | 说明 | 预期结果 |
|---------|------|------|---------|
| **Exp-3.1** | 单尺度域对抗 + Deep SVDD | Baseline | 基准 |
| **Exp-3.2** | 单尺度域对抗 + 原型网络 | 仅替换分类器 | 性能提升 |
| **Exp-3.3** | 多尺度域对抗 + Deep SVDD | 仅添加多尺度 | 性能提升 |
| **Exp-3.4** | 多尺度域对抗 + 原型网络 | 改进1 + 改进2 | 最优 |

**假设**：
- Exp-3.2 > Exp-3.1：原型网络优于Deep SVDD
- Exp-3.4 > Exp-3.3：原型网络在多尺度域对抗下更有效

#### 实验4：改进3的贡献（加权多尺度损失）

| 实验编号 | 配置 | 说明 | 预期结果 |
|---------|------|------|---------|
| **Exp-4.1** | 多尺度域对抗（均匀权重）+ 原型网络 | 改进1+2，均匀权重 | 基准 |
| **Exp-4.2** | 多尺度域对抗（加权）+ 原型网络 | 改进1+2+3，默认权重[0.1,0.3,0.6] | 性能提升 |
| **Exp-4.3** | 多尺度域对抗（反向权重）+ 原型网络 | 改进1+2，反向权重[0.6,0.3,0.1] | 性能下降 |

**假设**：
- Exp-4.2 > Exp-4.1：加权损失优于均匀权重
- Exp-4.2 > Exp-4.3：高层权重高更合理

---

### 第二部分：多尺度域对抗深度分析（优先级：⭐⭐⭐⭐）

**目的**：深入分析多尺度域对抗的机制和效果

#### 实验5：不同层的贡献分析

| 实验编号 | 使用的层 | 配置 | 说明 |
|---------|---------|------|------|
| **Exp-5.1** | 仅Layer 1（低层） | `use_layer_mask=[1,0,0]` | 仅低层域对抗 |
| **Exp-5.2** | 仅Layer 2（中层） | `use_layer_mask=[0,1,0]` | 仅中层域对抗 |
| **Exp-5.3** | 仅Layer 3（高层） | `use_layer_mask=[0,0,1]` | 仅高层域对抗 |
| **Exp-5.4** | Layer 1+2 | `use_layer_mask=[1,1,0]` | 低层+中层 |
| **Exp-5.5** | Layer 2+3 | `use_layer_mask=[0,1,1]` | 中层+高层 |
| **Exp-5.6** | Layer 1+3 | `use_layer_mask=[1,0,1]` | 低层+高层 |
| **Exp-5.7** | 所有层 | `use_layer_mask=[1,1,1]` | 完整配置 |

**假设**：
- Exp-5.3 > Exp-5.2 > Exp-5.1：高层特征更重要
- Exp-5.7 > 任何子集：所有层都有贡献
- Exp-5.5 > Exp-5.4：中高层组合优于低中层组合

#### 实验6：单尺度 vs 多尺度组合

| 实验编号 | 配置 | 说明 | 预期结果 |
|---------|------|------|---------|
| **Exp-6.1** | 仅单尺度（最终层） | `weight_loss_disc=0.5`, `weight_loss_ms_disc=0.0` | 基准 |
| **Exp-6.2** | 仅多尺度（所有层） | `weight_loss_disc=0.0`, `weight_loss_ms_disc=0.3` | 性能提升 |
| **Exp-6.3** | 单尺度 + 多尺度 | `weight_loss_disc=0.5`, `weight_loss_ms_disc=0.3` | 最优 |

**假设**：
- Exp-6.3 > Exp-6.2 > Exp-6.1：单尺度+多尺度组合最优

---

### 第三部分：损失函数消融（优先级：⭐⭐⭐）

**目的**：分析各个损失函数的相对重要性

#### 实验7：移除单个损失函数

| 实验编号 | 移除的损失 | 配置 | 预期影响 |
|---------|-----------|------|---------|
| **Exp-7.1** | 无 | MSPAD完整版 | 最优性能 |
| **Exp-7.2** | 单尺度域对抗 | `weight_loss_disc=0.0` | 性能下降 |
| **Exp-7.3** | 多尺度域对抗 | `weight_loss_ms_disc=0.0` | 性能下降 |
| **Exp-7.4** | 原型网络分类 | `weight_loss_pred=0.0` | 性能大幅下降 |
| **Exp-7.5** | 源域监督对比 | `weight_loss_src_sup=0.0` | 性能轻微下降 |
| **Exp-7.6** | 目标域注入对比 | `weight_loss_trg_inj=0.0` | 性能轻微下降 |

**假设**：
- Exp-7.4性能最差：分类损失最重要
- Exp-7.2和Exp-7.3性能下降：域对抗损失重要
- Exp-7.5和Exp-7.6影响较小：对比损失是辅助作用

---

## 参数敏感性分析

### 分析1：多尺度域对抗损失权重（优先级：⭐⭐⭐⭐）

**参数**：`weight_loss_ms_disc`

**参数范围**：0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.7

**分析维度**：
- 对AUPRC的影响
- 对F1 Score的影响
- 对训练稳定性的影响

**预期结果**：
- 最优值可能在0.2-0.4之间
- 权重过大会导致域对抗过强，影响分类性能
- 权重过小会导致多尺度域对齐不充分

**实验编号**：Sens-1.1 至 Sens-1.7

---

### 分析2：单尺度 vs 多尺度损失权重比例（优先级：⭐⭐⭐）

**分析配置**：
- 固定 `weight_loss_disc = 0.5`
- 变化 `weight_loss_ms_disc`：0.0 - 0.8
- 分析两者比例对性能的影响

**预期结果**：
- 存在最优比例（如 0.5:0.3）
- 两者需要平衡

**实验编号**：Sens-2.1 至 Sens-2.9

---

### 分析3：多尺度层权重配置（优先级：⭐⭐⭐）

**权重配置选项**：
- [0.1, 0.3, 0.6]：默认配置（低→高递增）
- [0.33, 0.33, 0.34]：均匀权重
- [0.6, 0.3, 0.1]：反向权重（低层权重高）
- [0.0, 0.0, 1.0]：仅高层
- [0.2, 0.4, 0.4]：中高层权重高
- [0.5, 0.3, 0.2]：低层权重较高
- [0.0, 0.5, 0.5]：仅中高层

**预期结果**：
- 默认配置 [0.1, 0.3, 0.6] 最优：高层权重应该更大
- 均匀权重次优：不同层的重要性不同
- 反向权重性能较差：低层权重过大不合理

**实验编号**：Sens-3.1 至 Sens-3.7

---

### 分析4：原型网络margin参数（优先级：⭐⭐）

**参数**：`prototypical_margin`

**参数范围**：0.5, 0.75, 1.0, 1.25, 1.5, 1.75, 2.0, 2.5

**分析维度**：
- 对分类性能的影响
- 对异常检测阈值的影响
- 对正常/异常样本分离度的影响

**预期结果**：
- 最优值可能在1.0-1.5之间
- margin过小会导致正常和异常样本分离不充分
- margin过大会导致训练困难

**实验编号**：Sens-4.1 至 Sens-4.8

---

### 分析5：其他损失权重敏感性（优先级：⭐）

**参数**：`weight_loss_disc`, `weight_loss_src_sup`, `weight_loss_trg_inj`

**参数范围**：
- `weight_loss_disc`: 0.0, 0.1, 0.3, 0.5, 0.7, 1.0
- `weight_loss_src_sup`: 0.0, 0.05, 0.1, 0.2, 0.3
- `weight_loss_trg_inj`: 0.0, 0.05, 0.1, 0.2, 0.3

**预期结果**：
- 存在最优权重组合
- 权重过大或过小都会降低性能

---

## 实验优先级与执行顺序

### 🎯 第一阶段：核心改进验证（Week 1-2，优先级：⭐⭐⭐⭐⭐）

**目标**：快速验证MSPAD的核心改进是否有效

#### Week 1：Baseline对比和改进1验证

1. **Day 1-2**: Baseline vs MSPAD完整版（Exp-1.1）
   - **目的**：确认MSPAD整体优于原始DACAD
   - **预期时间**：2个实验 × 4小时 = 8小时
   - **关键指标**：AUPRC提升是否达到预期（2-5%）

2. **Day 3-4**: 改进1的贡献（Exp-2.1, Exp-2.2）
   - **目的**：验证多尺度域对抗的有效性
   - **预期时间**：2个实验 × 4小时 = 8小时
   - **关键指标**：多尺度域对抗是否带来性能提升

3. **Day 5**: 改进2的贡献（Exp-3.1, Exp-3.2）
   - **目的**：验证原型网络的有效性
   - **预期时间**：2个实验 × 4小时 = 8小时
   - **关键指标**：原型网络是否优于Deep SVDD

#### Week 2：改进组合和加权损失验证

4. **Day 1-2**: 改进组合效果（Exp-2.4, Exp-3.4）
   - **目的**：验证多个改进的协同作用
   - **预期时间**：2个实验 × 4小时 = 8小时

5. **Day 3-4**: 改进3的贡献（Exp-4.1, Exp-4.2, Exp-4.3）
   - **目的**：验证加权多尺度损失的有效性
   - **预期时间**：3个实验 × 4小时 = 12小时

**第一阶段总结**：
- **总实验数**：10个
- **总时间**：约44小时（约5-6天）
- **关键决策点**：如果Exp-1.1没有显著提升，需要重新审视模型设计

---

### 🔍 第二阶段：多尺度域对抗深度分析（Week 3，优先级：⭐⭐⭐⭐）

**目标**：深入理解多尺度域对抗的机制

6. **Day 1-3**: 不同层的贡献分析（Exp-5.1 至 Exp-5.7）
   - **目的**：了解低层、中层、高层的相对重要性
   - **预期时间**：7个实验 × 4小时 = 28小时
   - **关键发现**：哪些层最重要？是否需要所有层？

7. **Day 4-5**: 单尺度 vs 多尺度组合（Exp-6.1, Exp-6.2, Exp-6.3）
   - **目的**：验证单尺度和多尺度的最佳组合方式
   - **预期时间**：3个实验 × 4小时 = 12小时

**第二阶段总结**：
- **总实验数**：10个
- **总时间**：约40小时（约5天）
- **关键发现**：多尺度域对抗的最优配置

---

### 📊 第三阶段：损失函数消融（Week 4，优先级：⭐⭐⭐）

**目标**：分析各个损失函数的相对重要性

8. **Day 1-3**: 移除单个损失函数（Exp-7.1 至 Exp-7.6）
   - **目的**：了解每个损失函数的贡献
   - **预期时间**：6个实验 × 4小时 = 24小时
   - **关键发现**：哪些损失函数是必需的？哪些是辅助的？

**第三阶段总结**：
- **总实验数**：6个
- **总时间**：约24小时（约3天）
- **关键发现**：损失函数的重要性排序

---

### ⚙️ 第四阶段：参数敏感性分析（Week 5-6，优先级：⭐⭐）

**目标**：优化关键参数配置

9. **Week 5**: 多尺度域对抗损失权重敏感性（Sens-1.1 至 Sens-1.7）
   - **目的**：找到最优的`weight_loss_ms_disc`
   - **预期时间**：7个实验 × 4小时 = 28小时

10. **Week 6 Day 1-2**: 单尺度 vs 多尺度权重比例（Sens-2.1 至 Sens-2.9）
    - **目的**：找到最优的权重比例
    - **预期时间**：9个实验 × 4小时 = 36小时

11. **Week 6 Day 3-4**: 多尺度层权重配置（Sens-3.1 至 Sens-3.7）
    - **目的**：找到最优的层权重配置
    - **预期时间**：7个实验 × 4小时 = 28小时

12. **Week 6 Day 5**: 原型网络margin参数（Sens-4.1 至 Sens-4.8）
    - **目的**：找到最优的`prototypical_margin`
    - **预期时间**：8个实验 × 4小时 = 32小时

**第四阶段总结**：
- **总实验数**：31个
- **总时间**：约124小时（约15-16天）
- **关键发现**：最优参数配置

---

## 实验执行建议

### 🚀 快速验证路径（推荐先执行）

如果你想快速验证MSPAD的有效性，建议按以下顺序执行：

1. **Baseline对比**（Exp-1.1）：1个实验，4小时
   - 如果MSPAD完整版没有显著提升，需要重新审视模型

2. **改进1验证**（Exp-2.1, Exp-2.2）：2个实验，8小时
   - 验证多尺度域对抗是否有效

3. **改进2验证**（Exp-3.1, Exp-3.2）：2个实验，8小时
   - 验证原型网络是否有效

4. **改进组合**（Exp-2.4）：1个实验，4小时
   - 验证两个改进的协同作用

**快速验证总计**：6个实验，约24小时（3天）

### 📈 完整实验路径

如果你想全面分析MSPAD，建议按阶段顺序执行：

- **阶段1**：核心改进验证（10个实验，5-6天）
- **阶段2**：多尺度域对抗深度分析（10个实验，5天）
- **阶段3**：损失函数消融（6个实验，3天）
- **阶段4**：参数敏感性分析（31个实验，15-16天）

**完整实验总计**：57个实验，约28-30天

---

## 实验配置

### 基础配置（所有实验共享）

```python
基础超参数 = {
    'num_epochs': 20,
    'batch_size': 256,
    'eval_batch_size': 256,
    'learning_rate': 1e-4,
    'dropout': 0.1,
    'weight_decay': 1e-4,
    'num_channels_TCN': '128-256-512',
    'dilation_factor_TCN': 3,
    'kernel_size_TCN': 7,
    'hidden_dim_MLP': 1024,
    'queue_size': 98304,
    'momentum': 0.99,
    'seed': 1234,  # 固定随机种子
}
```

### MSPAD完整配置

```python
MSPAD完整配置 = {
    'algo_name': 'MSPAD',
    'weight_loss_disc': 0.5,          # 单尺度域对抗损失权重
    'weight_loss_ms_disc': 0.3,       # 多尺度域对抗损失权重
    'weight_loss_pred': 1.0,          # 原型网络分类损失权重
    'weight_loss_src_sup': 0.1,       # 源域监督对比损失权重
    'weight_loss_trg_inj': 0.1,       # 目标域注入对比损失权重
    'prototypical_margin': 1.0,       # 原型网络间隔参数
    'scale_weights': [0.1, 0.3, 0.6], # 多尺度层权重
}
```

### 原始DACAD配置

```python
DACAD配置 = {
    'algo_name': 'dacad',
    'weight_loss_disc': 0.5,
    'weight_loss_ms_disc': 0.0,        # 无多尺度
    'weight_loss_pred': 1.0,           # Deep SVDD损失
    'weight_loss_src_sup': 0.1,
    'weight_loss_trg_inj': 0.1,
}
```

---

## 运行脚本

### 脚本1：消融实验自动化脚本

脚本文件：`main_new/run_ablation_experiments.py`

**使用方法**：
```bash
# 运行所有消融实验
python main_new/run_ablation_experiments.py

# 运行特定组
python main_new/run_ablation_experiments.py --group A  # 核心改进验证
python main_new/run_ablation_experiments.py --group B  # 多尺度深度分析
python main_new/run_ablation_experiments.py --group C  # 损失函数消融
```

### 脚本2：参数敏感性分析脚本

脚本文件：`main_new/run_sensitivity_analysis.py`

**使用方法**：
```bash
# 多尺度域对抗损失权重敏感性分析
python main_new/run_sensitivity_analysis.py --param weight_loss_ms_disc

# 原型网络margin敏感性分析
python main_new/run_sensitivity_analysis.py --param prototypical_margin

# 层权重配置敏感性分析
python main_new/run_sensitivity_analysis.py --param scale_weights
```

---

## 预期发现总结

### 核心改进验证

1. **MSPAD优于原始DACAD**：预期AUPRC提升2-5%
2. **多尺度域对抗有效**：预期提升1-3% AUPRC
3. **原型网络优于Deep SVDD**：预期提升1-2% AUPRC
4. **加权多尺度损失有效**：预期提升0.5-1% AUPRC

### 多尺度域对抗机制

1. **高层特征更重要**：高层域对齐的贡献 > 低层
2. **所有层都有贡献**：完整配置 > 任何子集
3. **单尺度+多尺度组合最优**：两者互补

### 参数敏感性

1. **最优多尺度损失权重**：`weight_loss_ms_disc ≈ 0.3`
2. **最优层权重配置**：`[0.1, 0.3, 0.6]`（低→高递增）
3. **最优margin值**：`prototypical_margin ≈ 1.0-1.5`

---

## 注意事项

1. **实验可复现性**：固定随机种子（seed=1234）
2. **资源管理**：合理安排GPU资源，避免同时运行过多实验
3. **结果备份**：定期备份实验结果和日志文件
4. **错误处理**：实验失败时记录错误信息，便于调试
5. **阶段性检查**：每个阶段完成后检查结果，决定是否继续下一阶段

---

## 推荐执行顺序

### 🎯 第一步（必须）：Baseline对比

**实验**：Baseline vs MSPAD完整版（Exp-1.1）

**原因**：
- 这是最重要的实验，验证MSPAD整体是否有效
- 如果这个实验失败，后续实验意义不大
- 时间成本低（1个实验，4小时）

**决策**：
- ✅ 如果MSPAD显著优于Baseline → 继续后续实验
- ❌ 如果MSPAD没有显著提升 → 需要重新审视模型设计

### 🔍 第二步（高优先级）：核心改进验证

**实验**：改进1验证（Exp-2.1, Exp-2.2）+ 改进2验证（Exp-3.1, Exp-3.2）

**原因**：
- 验证每个核心改进的独立贡献
- 了解哪个改进更重要
- 为后续优化提供方向

**决策**：
- 如果改进1有效 → 继续多尺度域对抗深度分析
- 如果改进2有效 → 继续原型网络参数优化
- 如果两个都有效 → 验证组合效果

### 📊 第三步（中优先级）：多尺度域对抗深度分析

**实验**：不同层的贡献分析（Exp-5.1 至 Exp-5.7）

**原因**：
- 深入理解多尺度域对抗的机制
- 找到最优的层配置
- 为参数优化提供依据

### ⚙️ 第四步（低优先级）：参数敏感性分析

**实验**：多尺度损失权重敏感性（Sens-1.1 至 Sens-1.7）

**原因**：
- 在确认改进有效后，优化参数配置
- 找到最优的超参数设置
- 提升模型性能

---

## 总结

根据MSPAD的核心改进，实验优先级如下：

1. **最高优先级**：Baseline对比（Exp-1.1）
2. **高优先级**：核心改进验证（Exp-2.x, Exp-3.x）
3. **中优先级**：多尺度域对抗深度分析（Exp-5.x, Exp-6.x）
4. **低优先级**：参数敏感性分析（Sens-x.x）

**建议先执行快速验证路径**（6个实验，3天），确认MSPAD有效后再进行完整实验。
